name: Nightly Data Refresh (GA4 + Sheets + WEX)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 7 * * *"   # 07:00 UTC daily
  push:
    paths:
      - "scripts/**"
      - ".github/workflows/refresh.yml"
      - "package.json"
      - "package-lock.json"

jobs:
  refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci

      - name: Write service account key
        run: |
          echo "${{ secrets.GCP_SA_JSON }}" | base64 -d > service-account.json
        shell: bash

      # ---------- GA4 ----------
      - name: Build data/ga4.json
        env:
          GA4_PROPERTY_ID: ${{ secrets.GA4_PROPERTY_ID }}
        run: |
          node scripts/fetch_ga4.js \
            --property "$GA4_PROPERTY_ID" \
            --sa ./service-account.json \
            --out data/ga4.json

      # ---------- Google Sheets (optional) ----------
      - name: Build data/sheets.json
        env:
          SHEETS_ID: ${{ secrets.SHEETS_ID }}
          SHEETS_RANGE: ${{ secrets.SHEETS_RANGE }}
        run: |
          node scripts/fetch_sheets.js \
            --sheetsId "$SHEETS_ID" \
            --range "$SHEETS_RANGE" \
            --sa ./service-account.json \
            --out data/sheets.json

      # ---------- WEX topics (optional) ----------
      - name: Build data/topics.json
        env:
          WEX_API_URL: ${{ secrets.WEX_API_URL }}
        run: |
          node scripts/fetch_wex.js \
            --base "${{ env.WEX_API_URL }}" \
            --out data/topics.json

      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add data/ga4.json data/sheets.json data/topics.json || true
          git commit -m "chore: refresh data" || echo "No changes to commit"
          git push
