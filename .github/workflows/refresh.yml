name: Refresh GA4 (daily + manual)

on:
  workflow_dispatch: {}          # <-- this makes the "Run workflow" button appear
  schedule:
    - cron: "20 07 * * *"        # run daily @ 07:20 UTC (change if you want)

permissions:
  contents: write

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: npm

      # Create a minimal package.json and force CommonJS so node can require() .cjs cleanly
      - name: Ensure package.json exists
        run: |
          if [ ! -f package.json ]; then
            cat > package.json <<'EOF'
          {
            "name": "analytics-refresh",
            "private": true,
            "version": "1.0.0",
            "license": "UNLICENSED",
            "type": "commonjs",
            "dependencies": {
              "@google-analytics/data": "^5.0.4"
            }
          }
EOF
          fi

      - name: Install deps
        run: npm i --no-audit --no-fund

      - name: Decode GCP service account key
        env:
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
        run: |
          mkdir -p .secrets
          echo "$GCP_SA_JSON" | base64 --decode > .secrets/gcp.json
          test -s .secrets/gcp.json || (echo "GCP key missing/empty" && exit 1)

      - name: Build GA4 JSON (KPIs + referrers + authors)
        env:
          GA4_PROPERTY_ID: ${{ secrets.GA4_PROPERTY_ID }}
          GCP_SA_FILE: .secrets/gcp.json
        run: |
          mkdir -p data
          node scripts/fetch_ga4.cjs

      # If you also build sheets.json/topics.json, keep those steps here.

      - name: Commit updated data
        run: |
          git config user.name  "gh-actions"
          git config user.email "actions@github.com"
          if [ -n "$(git status --porcelain data/)" ]; then
            git add data
            git commit -m "chore: refresh GA4 data"
            git push
          else
            echo "No changes to commit."
          fi
